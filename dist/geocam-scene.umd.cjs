(function(g,v){typeof exports=="object"&&typeof module<"u"?v(exports):typeof define=="function"&&define.amd?define(["exports"],v):(g=typeof globalThis<"u"?globalThis:g||self,v(g.GeocamScene={}))})(this,(function(g){"use strict";var v=typeof window<"u";const F={Promise:v?window.Promise:void 0};var G="4.25",C="next";function q(e){if(e.toLowerCase()===C)return C;var n=e&&e.match(/^(\d)\.(\d+)/);return n&&{major:parseInt(n[1],10),minor:parseInt(n[2],10)}}function M(e){return e===void 0&&(e=G),"https://js.arcgis.com/".concat(e,"/")}function D(e){e===void 0&&(e=G);var n=M(e),o=q(e);if(o!==C&&o.major===3){var t=o.minor<=10?"js/":"";return"".concat(n).concat(t,"esri/css/esri.css")}else return"".concat(n,"esri/themes/light/main.css")}function V(e){var n=document.createElement("link");return n.rel="stylesheet",n.href=e,n}function H(e,n){if(n){var o=document.querySelector(n);o.parentNode.insertBefore(e,o)}else document.head.appendChild(e)}function J(e){return document.querySelector('link[href*="'.concat(e,'"]'))}function K(e){return!e||q(e)?D(e):e}function $(e,n){var o=K(e),t=J(o);return t||(t=V(o),H(t,n)),t}var O={};function X(e){var n=document.createElement("script");return n.type="text/javascript",n.src=e,n.setAttribute("data-esri-loader","loading"),n}function R(e,n,o){var t;o&&(t=Z(e,o));var s=function(){n(e),e.removeEventListener("load",s,!1),t&&e.removeEventListener("error",t,!1)};e.addEventListener("load",s,!1)}function Z(e,n){var o=function(t){n(t.error||new Error("There was an error attempting to load ".concat(e.src))),e.removeEventListener("error",o,!1)};return e.addEventListener("error",o,!1),o}function W(){return document.querySelector("script[data-esri-loader]")}function k(){var e=window.require;return e&&e.on}function _(e){e===void 0&&(e={});var n={};[O,e].forEach(function(s){for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(n[r]=s[r])});var o=n.version,t=n.url||M(o);return new F.Promise(function(s,r){var c=W();if(c){var E=c.getAttribute("src");E!==t?r(new Error("The ArcGIS API for JavaScript is already loaded (".concat(E,")."))):k()?s(c):R(c,s,r)}else if(k())r(new Error("The ArcGIS API for JavaScript is already loaded."));else{var i=n.css;if(i){var f=i===!0;$(f?o:i,n.insertCssBefore)}c=X(t),R(c,function(){c.setAttribute("data-esri-loader","loaded"),s(c)},r),document.body.appendChild(c)}})}function U(e){return new F.Promise(function(n,o){var t=window.require.on("error",o);window.require(e,function(){for(var s=[],r=0;r<arguments.length;r++)s[r]=arguments[r];t.remove(),n(s)})})}function z(e,n){if(n===void 0&&(n={}),k())return U(e);var o=W(),t=o&&o.getAttribute("src");return!n.url&&t&&(n.url=t),_(n).then(function(){return U(e)})}async function Q(e,n){const o={version:"4.27",css:!0};let t;const s=[{name:"Zoom"}],r=[{name:"Search",icon:"esri-icon-search",options:{includeDefaultSources:!0}},{name:"BasemapGallery",icon:"esri-icon-basemap"},{name:"LayerList",icon:"esri-icon-layer-list"},{name:"Legend",icon:"esri-icon-feature-layer"},{name:"Editor",icon:"esri-icon-edit"},{name:"DirectLineMeasurement3D",icon:"esri-icon-measure",watchExpandFor:{expanded:(i,f,x,m)=>{m.content.viewModel.clear()}},watchWidgetFor:{"viewModel.state":(i,f,x,m)=>{i==="measuring"?m.view.emit("clickable",!1):i!=="measuring"&&f==="measuring"&&m.view.emit("clickable",!0),console.log("viewmodel state change",i,m)}}}],c=s?s.map(i=>i.class?i.class:`esri/widgets/${i.name}`):[],E=r?r.map(i=>i.class?i.class:`esri/widgets/${i.name}`):[];return await z(["esri/identity/IdentityManager","esri/WebScene","esri/views/SceneView","esri/widgets/Expand","esri/portal/Portal"].concat(c).concat(E),o).then(([i,f,x,m,Y,...B])=>{window.ARCGIS_TOKEN&&i.registerToken({server:window.ARCGIS_SERVER,token:window.ARCGIS_TOKEN});const ee=new URLSearchParams(window.location.search.toLowerCase());let L;const b=n||ee.get("websceneid");if(b){const d={id:b};if(b.startsWith("http")){const l=b.split("/");d.id=l.pop();const A=l.join("/"),u=new Y({url:A});d.portal=u}L=new f({portalItem:d})}else L=new f({basemap:"satellite",ground:"world-elevation"});L.load().then(()=>{t=new x({container:e,map:L,ui:{components:["attribution"]}});const d=document.getElementsByTagName("geocam-viewer-arcgis-scene")[0];d&&d.link&&(console.log("map linking to connector",t),d.link(t));const l=function(u){return u.layers.items.map(h=>h.layers?l(h):h)},A=function(u){return l(u).flat()};t.when(async()=>{let u=[],h=!1;const j=A(t.map);for(let w=0;w<j.length;w++){const a=j[w];if(await t.whenLayerView(a),a.editingEnabled&&(h=!0),a.fields){const y=a.fields.map(p=>p.name);u.push({layer:a,searchFields:y})}}const I=[];c.forEach((w,a)=>{const y=B[a],p=new y({view:t,container:document.createElement("div"),...s[a].options});I.push(p)}),E.forEach((w,a)=>{if(w==="esri/widgets/Editor"&&!h)return;w==="esri/widgets/Search"&&(r[a].options=r[a].options||{},r[a].options.sources=r[a].options.sources||u);const y=B[a+c.length],p=new y({view:t,container:document.createElement("div"),...r[a].options});console.log("loaded widget",{view:t,container:document.createElement("div"),...r[a].options});const T=new m({view:t,group:"expands",autoCollapse:!0,content:p,expandIconClass:r[a].icon});r[a].watchWidgetFor&&Object.keys(r[a].watchWidgetFor).forEach(S=>{p.watch(S,(...P)=>r[a].watchWidgetFor[S].apply(p,P))}),r[a].watchExpandFor&&Object.keys(r[a].watchExpandFor).forEach(S=>{T.watch(S,(...P)=>r[a].watchExpandFor[S].apply(T,P))}),I.push(T)}),t.ui.add(I,"top-right"),console.log("All widgets added")})}).catch(d=>{const l=d&&d.message?d?.message+`
`+d?.details?.error?.message:"An unknown erro occurred trying to load the map.";alert(l),console.error("Error loading scene:",l)})}),t}class N extends HTMLElement{constructor(){super(),console.log("Scene init")}connectedCallback(){console.log("Scene connected");const n=this,o=n.getAttribute("data-websceneid");Q(n,o)}disconnectedCallback(){console.log("Scene disconnected")}}window.customElements.define("geocam-scene",N),g.GeocamScene=N,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})}));
