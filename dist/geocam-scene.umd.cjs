(function(g,E){typeof exports=="object"&&typeof module<"u"?E(exports):typeof define=="function"&&define.amd?define(["exports"],E):(g=typeof globalThis<"u"?globalThis:g||self,E(g.GeocamScene={}))})(this,function(g){"use strict";var E=typeof window<"u";const F={Promise:E?window.Promise:void 0};var G="4.25",k="next";function q(e){if(e.toLowerCase()===k)return k;var n=e&&e.match(/^(\d)\.(\d+)/);return n&&{major:parseInt(n[1],10),minor:parseInt(n[2],10)}}function M(e){return e===void 0&&(e=G),"https://js.arcgis.com/".concat(e,"/")}function D(e){e===void 0&&(e=G);var n=M(e),o=q(e);if(o!==k&&o.major===3){var t=o.minor<=10?"js/":"";return"".concat(n).concat(t,"esri/css/esri.css")}else return"".concat(n,"esri/themes/light/main.css")}function V(e){var n=document.createElement("link");return n.rel="stylesheet",n.href=e,n}function H(e,n){if(n){var o=document.querySelector(n);o.parentNode.insertBefore(e,o)}else document.head.appendChild(e)}function J(e){return document.querySelector('link[href*="'.concat(e,'"]'))}function K(e){return!e||q(e)?D(e):e}function $(e,n){var o=K(e),t=J(o);return t||(t=V(o),H(t,n)),t}var O={};function X(e){var n=document.createElement("script");return n.type="text/javascript",n.src=e,n.setAttribute("data-esri-loader","loading"),n}function R(e,n,o){var t;o&&(t=Z(e,o));var s=function(){n(e),e.removeEventListener("load",s,!1),t&&e.removeEventListener("error",t,!1)};e.addEventListener("load",s,!1)}function Z(e,n){var o=function(t){n(t.error||new Error("There was an error attempting to load ".concat(e.src))),e.removeEventListener("error",o,!1)};return e.addEventListener("error",o,!1),o}function W(){return document.querySelector("script[data-esri-loader]")}function x(){var e=window.require;return e&&e.on}function _(e){e===void 0&&(e={});var n={};[O,e].forEach(function(s){for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(n[r]=s[r])});var o=n.version,t=n.url||M(o);return new F.Promise(function(s,r){var d=W();if(d){var y=d.getAttribute("src");y!==t?r(new Error("The ArcGIS API for JavaScript is already loaded (".concat(y,")."))):x()?s(d):R(d,s,r)}else if(x())r(new Error("The ArcGIS API for JavaScript is already loaded."));else{var i=n.css;if(i){var f=i===!0;$(f?o:i,n.insertCssBefore)}d=X(t),R(d,function(){d.setAttribute("data-esri-loader","loaded"),s(d)},r),document.body.appendChild(d)}})}function U(e){return new F.Promise(function(n,o){var t=window.require.on("error",o);window.require(e,function(){for(var s=[],r=0;r<arguments.length;r++)s[r]=arguments[r];t.remove(),n(s)})})}function z(e,n){if(n===void 0&&(n={}),x())return U(e);var o=W(),t=o&&o.getAttribute("src");return!n.url&&t&&(n.url=t),_(n).then(function(){return U(e)})}async function Q(e,n){const o={version:"4.27",css:!0};let t;const s=[{name:"Zoom"}],r=[{name:"Search",icon:"esri-icon-search",options:{includeDefaultSources:!0}},{name:"BasemapGallery",icon:"esri-icon-basemap"},{name:"LayerList",icon:"esri-icon-layer-list"},{name:"Legend",icon:"esri-icon-feature-layer"},{name:"Editor",icon:"esri-icon-edit"},{name:"DirectLineMeasurement3D",icon:"esri-icon-measure",watchExpandFor:{expanded:(i,f,A,m)=>{m.content.viewModel.clear()}},watchWidgetFor:{"viewModel.state":(i,f,A,m)=>{i==="measuring"?m.view.emit("clickable",!1):i!=="measuring"&&f==="measuring"&&m.view.emit("clickable",!0),console.log("viewmodel state change",i,m)}}}],d=s?s.map(i=>i.class?i.class:`esri/widgets/${i.name}`):[],y=r?r.map(i=>i.class?i.class:`esri/widgets/${i.name}`):[];return await z(["esri/identity/IdentityManager","esri/WebScene","esri/views/SceneView","esri/widgets/Expand","esri/portal/Portal"].concat(d).concat(y),o).then(([i,f,A,m,Y,...B])=>{window.ARCGIS_TOKEN&&i.registerToken({server:window.ARCGIS_SERVER,token:window.ARCGIS_TOKEN});const ee=new URLSearchParams(window.location.search.toLowerCase());let b;const C=n||ee.get("websceneid");if(C){const c={id:C};if(C.startsWith("http")){const u=C.split("/");c.id=u.pop();const h=u.join("/"),l=new Y({url:h});c.portal=l}b=new f({portalItem:c})}else b=new f({basemap:"satellite",ground:"world-elevation"});b.load().then(()=>{t=new A({container:e,map:b,ui:{components:["attribution"]}});const c=document.getElementsByTagName("geocam-viewer-arcgis-scene")[0];c&&c.link&&(console.log("map linking to connector",t),c.link(t));const u=function(l){return l.layers.items.map(v=>v.layers?u(v):v)},h=function(l){return u(l).flat()};t.when(async()=>{let l=[],v=!1;const j=h(t.map);for(let w=0;w<j.length;w++){const a=j[w];if(await t.whenLayerView(a),a.editingEnabled&&(v=!0),a.fields){const S=a.fields.map(p=>p.name);l.push({layer:a,searchFields:S})}}const I=[];d.forEach((w,a)=>{const S=B[a],p=new S({view:t,container:document.createElement("div"),...s[a].options});I.push(p)}),y.forEach((w,a)=>{if(w==="esri/widgets/Editor"&&!v)return;w==="esri/widgets/Search"&&(r[a].options=r[a].options||{},r[a].options.sources=r[a].options.sources||l);const S=B[a+d.length],p=new S({view:t,container:document.createElement("div"),...r[a].options});console.log("loaded widget",{view:t,container:document.createElement("div"),...r[a].options});const T=new m({view:t,group:"expands",autoCollapse:!0,content:p,expandIconClass:r[a].icon});r[a].watchWidgetFor&&Object.keys(r[a].watchWidgetFor).forEach(L=>{p.watch(L,(...P)=>r[a].watchWidgetFor[L].apply(p,P))}),r[a].watchExpandFor&&Object.keys(r[a].watchExpandFor).forEach(L=>{T.watch(L,(...P)=>r[a].watchExpandFor[L].apply(T,P))}),I.push(T)}),t.ui.add(I,"top-right"),console.log("All widgets added")})}).catch(c=>{var h,l;const u=c&&c.message?(c==null?void 0:c.message)+`
`+((l=(h=c==null?void 0:c.details)==null?void 0:h.error)==null?void 0:l.message):"An unknown erro occurred trying to load the map.";alert(u),console.error("Error loading scene:",u)})}),t}class N extends HTMLElement{constructor(){super(),console.log("Scene init")}connectedCallback(){console.log("Scene connected");const n=this,o=n.getAttribute("data-websceneid");Q(n,o)}disconnectedCallback(){console.log("Scene disconnected")}}window.customElements.define("geocam-scene",N),g.GeocamScene=N,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
