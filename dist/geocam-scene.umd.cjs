(function(p,g){typeof exports=="object"&&typeof module<"u"?g(exports):typeof define=="function"&&define.amd?define(["exports"],g):(p=typeof globalThis<"u"?globalThis:p||self,g(p.GeocamScene={}))})(this,function(p){"use strict";var g=typeof window<"u";const P={Promise:g?window.Promise:void 0};var F="4.25",b="next";function G(e){if(e.toLowerCase()===b)return b;var n=e&&e.match(/^(\d)\.(\d+)/);return n&&{major:parseInt(n[1],10),minor:parseInt(n[2],10)}}function q(e){return e===void 0&&(e=F),"https://js.arcgis.com/".concat(e,"/")}function j(e){e===void 0&&(e=F);var n=q(e),o=G(e);if(o!==b&&o.major===3){var t=o.minor<=10?"js/":"";return"".concat(n).concat(t,"esri/css/esri.css")}else return"".concat(n,"esri/themes/light/main.css")}function D(e){var n=document.createElement("link");return n.rel="stylesheet",n.href=e,n}function V(e,n){if(n){var o=document.querySelector(n);o.parentNode.insertBefore(e,o)}else document.head.appendChild(e)}function H(e){return document.querySelector('link[href*="'.concat(e,'"]'))}function J(e){return!e||G(e)?j(e):e}function K(e,n){var o=J(e),t=H(o);return t||(t=D(o),V(t,n)),t}var $={};function O(e){var n=document.createElement("script");return n.type="text/javascript",n.src=e,n.setAttribute("data-esri-loader","loading"),n}function M(e,n,o){var t;o&&(t=X(e,o));var s=function(){n(e),e.removeEventListener("load",s,!1),t&&e.removeEventListener("error",t,!1)};e.addEventListener("load",s,!1)}function X(e,n){var o=function(t){n(t.error||new Error("There was an error attempting to load ".concat(e.src))),e.removeEventListener("error",o,!1)};return e.addEventListener("error",o,!1),o}function R(){return document.querySelector("script[data-esri-loader]")}function C(){var e=window.require;return e&&e.on}function Z(e){e===void 0&&(e={});var n={};[$,e].forEach(function(s){for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(n[r]=s[r])});var o=n.version,t=n.url||q(o);return new P.Promise(function(s,r){var c=R();if(c){var h=c.getAttribute("src");h!==t?r(new Error("The ArcGIS API for JavaScript is already loaded (".concat(h,")."))):C()?s(c):M(c,s,r)}else if(C())r(new Error("The ArcGIS API for JavaScript is already loaded."));else{var i=n.css;if(i){var u=i===!0;K(u?o:i,n.insertCssBefore)}c=O(t),M(c,function(){c.setAttribute("data-esri-loader","loaded"),s(c)},r),document.body.appendChild(c)}})}function W(e){return new P.Promise(function(n,o){var t=window.require.on("error",o);window.require(e,function(){for(var s=[],r=0;r<arguments.length;r++)s[r]=arguments[r];t.remove(),n(s)})})}function _(e,n){if(n===void 0&&(n={}),C())return W(e);var o=R(),t=o&&o.getAttribute("src");return!n.url&&t&&(n.url=t),Z(n).then(function(){return W(e)})}async function z(e,n){const o={version:"4.27",css:!0};let t;const s=[{name:"Zoom"}],r=[{name:"Search",icon:"esri-icon-search",options:{includeDefaultSources:!0}},{name:"BasemapGallery",icon:"esri-icon-basemap"},{name:"LayerList",icon:"esri-icon-layer-list"},{name:"Legend",icon:"esri-icon-feature-layer"},{name:"Editor",icon:"esri-icon-edit"},{name:"DirectLineMeasurement3D",icon:"esri-icon-measure",watchExpandFor:{expanded:(i,u,x,f)=>{f.content.viewModel.clear()}},watchWidgetFor:{"viewModel.state":(i,u,x,f)=>{i==="measuring"?f.view.emit("clickable",!1):i!=="measuring"&&u==="measuring"&&f.view.emit("clickable",!0),console.log("viewmodel state change",i,f)}}}],c=s?s.map(i=>i.class?i.class:`esri/widgets/${i.name}`):[],h=r?r.map(i=>i.class?i.class:`esri/widgets/${i.name}`):[];return await _(["esri/identity/IdentityManager","esri/WebScene","esri/views/SceneView","esri/widgets/Expand","esri/portal/Portal"].concat(c).concat(h),o).then(([i,u,x,f,Q,...N])=>{window.ARCGIS_TOKEN&&i.registerToken({server:window.ARCGIS_SERVER,token:window.ARCGIS_TOKEN});const Y=new URLSearchParams(window.location.search.toLowerCase());let k;const S=n||Y.get("websceneid");if(S){const d={id:S};if(S.startsWith("http")){const l=S.split("/");d.id=l.pop();const L=l.join("/"),v=new Q({url:L});d.portal=v}k=new u({portalItem:d})}else k=new u({basemap:"satellite",ground:"world-elevation"});t=new x({container:e,map:k,ui:{components:["attribution"]}});const I=document.getElementsByTagName("geocam-viewer-arcgis-scene")[0];I&&I.link&&(console.log("map linking to connector",t),I.link(t));const B=function(d){return d.layers.items.map(l=>l.layers?B(l):l)},ee=function(d){return B(d).flat()};t.when(async()=>{let d=[],l=!1;const L=ee(t.map);for(let m=0;m<L.length;m++){const a=L[m];if(await t.whenLayerView(a),a.editingEnabled&&(l=!0),a.fields){const E=a.fields.map(w=>w.name);d.push({layer:a,searchFields:E})}}const v=[];c.forEach((m,a)=>{const E=N[a],w=new E({view:t,container:document.createElement("div"),...s[a].options});v.push(w)}),h.forEach((m,a)=>{if(m==="esri/widgets/Editor"&&!l)return;m==="esri/widgets/Search"&&(r[a].options=r[a].options||{},r[a].options.sources=r[a].options.sources||d);const E=N[a+c.length],w=new E({view:t,container:document.createElement("div"),...r[a].options});console.log("loaded widget",{view:t,container:document.createElement("div"),...r[a].options});const A=new f({view:t,group:"expands",autoCollapse:!0,content:w,expandIconClass:r[a].icon});r[a].watchWidgetFor&&Object.keys(r[a].watchWidgetFor).forEach(y=>{w.watch(y,(...T)=>r[a].watchWidgetFor[y].apply(w,T))}),r[a].watchExpandFor&&Object.keys(r[a].watchExpandFor).forEach(y=>{A.watch(y,(...T)=>r[a].watchExpandFor[y].apply(A,T))}),v.push(A)}),t.ui.add(v,"top-right"),console.log("All widgets added")})}),t}class U extends HTMLElement{constructor(){super(),console.log("Scene init")}connectedCallback(){console.log("Scene connected");const n=this,o=n.getAttribute("data-websceneid");z(n,o)}disconnectedCallback(){console.log("Scene disconnected")}}window.customElements.define("geocam-scene",U),p.GeocamScene=U,Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
