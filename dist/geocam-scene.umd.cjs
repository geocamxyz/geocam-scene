(function(p,g){typeof exports=="object"&&typeof module<"u"?g(exports):typeof define=="function"&&define.amd?define(["exports"],g):(p=typeof globalThis<"u"?globalThis:p||self,g(p.GeocamScene={}))})(this,function(p){"use strict";var g=typeof window<"u";const I={Promise:g?window.Promise:void 0};var T="4.25",b="next";function q(e){if(e.toLowerCase()===b)return b;var n=e&&e.match(/^(\d)\.(\d+)/);return n&&{major:parseInt(n[1],10),minor:parseInt(n[2],10)}}function W(e){return e===void 0&&(e=T),"https://js.arcgis.com/".concat(e,"/")}function N(e){e===void 0&&(e=T);var n=W(e),o=q(e);if(o!==b&&o.major===3){var t=o.minor<=10?"js/":"";return"".concat(n).concat(t,"esri/css/esri.css")}else return"".concat(n,"esri/themes/light/main.css")}function R(e){var n=document.createElement("link");return n.rel="stylesheet",n.href=e,n}function H(e,n){if(n){var o=document.querySelector(n);o.parentNode.insertBefore(e,o)}else document.head.appendChild(e)}function J(e){return document.querySelector('link[href*="'.concat(e,'"]'))}function V(e){return!e||q(e)?N(e):e}function $(e,n){var o=V(e),t=J(o);return t||(t=R(o),H(t,n)),t}var X={};function Z(e){var n=document.createElement("script");return n.type="text/javascript",n.src=e,n.setAttribute("data-esri-loader","loading"),n}function M(e,n,o){var t;o&&(t=z(e,o));var s=function(){n(e),e.removeEventListener("load",s,!1),t&&e.removeEventListener("error",t,!1)};e.addEventListener("load",s,!1)}function z(e,n){var o=function(t){n(t.error||new Error("There was an error attempting to load ".concat(e.src))),e.removeEventListener("error",o,!1)};return e.addEventListener("error",o,!1),o}function U(){return document.querySelector("script[data-esri-loader]")}function x(){var e=window.require;return e&&e.on}function K(e){e===void 0&&(e={});var n={};[X,e].forEach(function(s){for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(n[r]=s[r])});var o=n.version,t=n.url||W(o);return new I.Promise(function(s,r){var c=U();if(c){var h=c.getAttribute("src");h!==t?r(new Error("The ArcGIS API for JavaScript is already loaded (".concat(h,")."))):x()?s(c):M(c,s,r)}else if(x())r(new Error("The ArcGIS API for JavaScript is already loaded."));else{var i=n.css;if(i){var w=i===!0;$(w?o:i,n.insertCssBefore)}c=Z(t),M(c,function(){c.setAttribute("data-esri-loader","loaded"),s(c)},r),document.body.appendChild(c)}})}function G(e){return new I.Promise(function(n,o){var t=window.require.on("error",o);window.require(e,function(){for(var s=[],r=0;r<arguments.length;r++)s[r]=arguments[r];t.remove(),n(s)})})}function Q(e,n){if(n===void 0&&(n={}),x())return G(e);var o=U(),t=o&&o.getAttribute("src");return!n.url&&t&&(n.url=t),K(n).then(function(){return G(e)})}async function Y(e,n){const o={version:"4.27",css:!0};let t;const s=[{name:"Zoom"}],r=[{name:"Search",icon:"esri-icon-search",options:{includeDefaultSources:!0}},{name:"BasemapGallery",icon:"esri-icon-basemap"},{name:"LayerList",icon:"esri-icon-layer-list"},{name:"Legend",icon:"esri-icon-feature-layer"},{name:"Editor",icon:"esri-icon-edit"},{name:"DirectLineMeasurement3D",icon:"esri-icon-measure",watchExpandFor:{expanded:(i,w,C,u)=>{u.content.viewModel.clear()}},watchWidgetFor:{"viewModel.state":(i,w,C,u)=>{i==="measuring"?u.view.emit("clickable",!1):i!=="measuring"&&w==="measuring"&&u.view.emit("clickable",!0),console.log("viewmodel state change",i,u)}}}],c=s?s.map(i=>i.class?i.class:`esri/widgets/${i.name}`):[],h=r?r.map(i=>i.class?i.class:`esri/widgets/${i.name}`):[];return await Q(["esri/WebScene","esri/views/SceneView","esri/widgets/Expand","esri/portal/Portal"].concat(c).concat(h),o).then(([i,w,C,u,...j])=>{const O=new URLSearchParams(window.location.search.toLowerCase());let k;const L=n||O.get("websceneid");if(L){const d={id:L};if(L.startsWith("http")){const l=L.split("/");d.id=l.pop();const S=l.join("/"),v=new u({url:S});d.portal=v}k=new i({portalItem:d})}else k=new i({basemap:"satellite",ground:"world-elevation"});t=new w({container:e,map:k,ui:{components:["attribution"]}});const P=document.getElementsByTagName("geocam-viewer-arcgis-scene")[0];P&&P.link&&(console.log("map linking to connector",t),P.link(t));const D=function(d){return d.layers.items.map(l=>l.layers?D(l):l)},_=function(d){return D(d).flat()};t.when(async()=>{let d=[],l=!1;const S=_(t.map);for(let f=0;f<S.length;f++){const a=S[f];if(await t.whenLayerView(a),a.editingEnabled&&(l=!0),a.fields){const E=a.fields.map(m=>m.name);d.push({layer:a,searchFields:E})}}const v=[];c.forEach((f,a)=>{const E=j[a],m=new E({view:t,container:document.createElement("div"),...s[a].options});v.push(m)}),h.forEach((f,a)=>{if(f==="esri/widgets/Editor"&&!l)return;f==="esri/widgets/Search"&&(r[a].options=r[a].options||{},r[a].options.sources=r[a].options.sources||d);const E=j[a+c.length],m=new E({view:t,container:document.createElement("div"),...r[a].options});console.log("loaded widget",{view:t,container:document.createElement("div"),...r[a].options});const A=new C({view:t,group:"expands",autoCollapse:!0,content:m,expandIconClass:r[a].icon});r[a].watchWidgetFor&&Object.keys(r[a].watchWidgetFor).forEach(y=>{m.watch(y,(...F)=>r[a].watchWidgetFor[y].apply(m,F))}),r[a].watchExpandFor&&Object.keys(r[a].watchExpandFor).forEach(y=>{A.watch(y,(...F)=>r[a].watchExpandFor[y].apply(A,F))}),v.push(A)}),t.ui.add(v,"top-right"),console.log("All widgets added")})}),t}class B extends HTMLElement{constructor(){super(),console.log("Scene init")}connectedCallback(){console.log("Scene connected");const n=this,o=n.getAttribute("data-websceneid");Y(n,o)}disconnectedCallback(){console.log("Scene disconnected")}}window.customElements.define("geocam-scene",B),p.GeocamScene=B,Object.defineProperty(p,Symbol.toStringTag,{value:"Module"})});
